---
title: "The effect of dormancy on extinction probability"
output:
  html_document:
    df_print: paged
---

Based on:
Lennon, J. T., den Hollander, F., Wilke-Berenguer, M. & Blath, J. Principles of seed banks and the emergence of complexity from dormancy. Nature Communications 12, (2021).

Usually only external forces such as environmental conditions or resource availability are considered when looking at fluctuations and competition between species, but the ability to enter dormancy can have a significant impact in how successful a species is during competition. This model will model how extinction rates across phylogeny vary with dormancy.

###########################
-Taxa with dormancy grow slower than non-dormancy
-Taxa with dormancy outcompete non-dormancy
-Taxa without dormancy grow faster than dormancy
-Taxa without dormancy are outcompeted by dormancy
-If no competition, species without dormancy will have a higher speciation rate and lower extinction rate
-If competition present, species with dormancy will have a higher speciation rate and lower extinction rate

SpN = Not dormancy capable species
SpD = Dormancy capable species
Rep = Reproduction rate
Dea = Death rate
Ext = Extinction rate
Pop = Population size
Esc = Escape rate
SR = SpeciationRate
ER = ExtinctionRate
```{r}
# SpD_Rep <-  # > 0, < Sp1_Re
# SpD_Dea <-  # < Sp2_Re
# SpD_Esc <- 
# SpD_Pop <- ((Sp2_Rep - Sp2s_Dea) / (1 - Sp2_Esc))
#   
# SpN_Rep <-  # > 0, > Sp2_Rep
# SpN_Dea <-  # < Sp2_Re
# SpN_Pop <- (Sp1_Rep - Sp1_Dea)
#   
# SpD_SR <- 
# SpD_ER <- 
# SpN_SR <- 
# SpN_ER <- 
```

```{r}
library("hisse")
```

Use phylogeny and trait data from homework 8 to make and test the model.
```{r}
require("corHMM") # just like library(), but is for packages that are used within a function.
# corHMM extimates hidden rates underlying the evolution of a binary character. It's a hidden rates model. 
data(primates)
ls() # lists all data and values in the environment
print(primates)
require(phytools)
```
I want to have all possible trait combinations, so I made everything in the Hylobates genera have 1 for T1 (warning: made-up data!)
```{r}
primates$trait[which(grepl("Hylobates", primates$trait[,1])),2] <- 1
print(primates)
```

```{r}
trait1 <- primates$trait[,2]
names(trait1) <- primates$trait[,1]
primates$tree <- ape::multi2di(primates$tree)
plotSimmap(make.simmap(primates$tree, trait1), 
           pts = FALSE, 
           fsize = 0.8)
```

Make a correlation matrix: compare "equal rates" to "all rates different"
```{r}
# makes a rate matrix, can make a matrix without this code if needed.
# rate matrix maker in the corHMM package doesn't exist anymore, so use ::: to find it :)
rate.mat.er <- corHMM:::rate.mat.maker(rate.cat = 1,
                              hrm = FALSE,
                              ntraits = 1,
                              nstates = 2,
                              model = "ER") # equal rates model
# find the optimized rates
pp.er <- corHMM(phy = primates$tree,
                data = primates$trait[,c(1,2)],
                rate.cat = 1,
                rate.mat = rate.mat.er,
                node.states = "marginal")


rate.mat.ard <- corHMM:::rate.mat.maker(rate.cat = 1,
                                        hrm = FALSE,
                                        ntraits = 1,
                                        nstates = 2,
                                        model = "ARD") # ARD = all rates different model
# find the optimized rates
pp.ard <- corHMM(phy = primates$tree,
                 data = primates$trait[,c(1,2)],
                 rate.cat = 1,
                 rate.mat = rate.mat.ard,
                 node.states = "marginal")


if (pp.er$AICc < pp.ard$AICc) {
  print(paste("The equal rates model AICc (", pp.er$AICc, ") is lower than the all rates different model AICc (", pp.ard$AICc, ")"))
} else {
  print(paste("The all rates different model AICc (", pp.ard$AICc, ") is lower than the equal rates  model AICc (", pp.er$AICc, ")"))
}
```