---
title: "Final Project"
output: html_notebook
---

Using diversitree packages...
```{r}
library("diversitree")
library("ape")
library("phangorn")
library("dplyr")
```

Use phylogeny and trait data from homework 8 to make and test the model.
I want to have all possible trait combinations, so I made everything in the Hylobates genera have 1 for T1 (warning: made-up data!)
```{r, cache = TRUE}
require("corHMM")
require(phytools)
data(primates)
primates$trait[which(grepl("Hylobates", primates$trait[,1])),2] <- 1
```

Tree isn't bifurcating, use multi2di to make the tree bifurcating.
```{r}
primates$tree <- multi2di(primates$tree)
```

```{r, cache = TRUE}
# trait1 = dormancy absent (0) / dormancy present (1)
trait1 <- primates$trait[,2]
names(trait1) <- primates$trait[,1]
primates$tree <- nnls.tree(cophenetic(primates$tree), 
                           primates$tree, 
                           rooted=TRUE,
                           trace=0)
plotSimmap(make.simmap(primates$tree, trait1), 
           pts = FALSE, 
           fsize = 0.8)
```
```{r}
# trait2 = competition absent (0) / competition present (1)
trait2 <- primates$trait[,3]
names(trait2) <- primates$trait[,1]
plotSimmap(make.simmap(primates$tree, trait2), 
           pts = FALSE, 
           fsize = 0.8)
```

Make a BiSSE function using make.bisse. Use this function to test all the different hypotheses of speciation, extinction, and transition rates.
```{r}
bis <- make.bisse(tree = primates$tree,
                  states = trait1,
                  sampling.f = c(1,1))
```
bis() is now a function. Needs parameters lambda0, lambda1, mu0, mu1, q01, q10.

SpN = lambda0 =  # speciation rate, no dormancy
SpD = lambda1 =  # speciation rate, dormancy (/p)
ExN = mu0 =      # extinction rate, no dormancy
ExD = mu1 =      # extinction rate, dormancy (/p)
TrN = q01 =      # transition rate, no -> dormancy
TrD = q10 =      # transition rate, dormancy -> no
p   =            # escape rate

The results are in log-likelihood, so use exp() to make comparisons easier. The most positive likelihood is best.
For example: exp(bis(c(1,2,3,1,2,3)))

```{r}
startparambisse <- starting.point.bisse(tree = primates$tree)
```
   lambda0    lambda1        mu0        mu1        q01        q10 
0.06882283 0.06882283 0.00000000 0.00000000 0.01376457 0.01376457 
```{r}
bis_fit <- find.mle(bis, startparambisse)
bis_fit
```


Optimize the likelihoods:
```{r}
 dormancy_lik <- function(param, bisse_fn) {
 lambda0 <- params$popsize0+4
 mu0 <- params$extinction_dormrancy + 0.15 * params$extinction_nndormand
 q01 <- params$dormancy_escape_rate / params$N
 return(-bisse_fn(c(lambda0,..)))
}
 fit_model <- function(bisse_fn) {
 starting_guesses <- c(3, 1, 2)
 return(optim(starting_guesses, dormancy_lik, bisse_fn=bisse_fn))
}
```

SpN = lambda0 =  # speciation rate, no dormancy
SpD = lambda1 =  # speciation rate, dormancy (/p)
ExN = mu0 =      # extinction rate, no dormancy
ExD = mu1 =      # extinction rate, dormancy (/p)
TrN = q01 =      # transition rate, no -> dormancy
TrD = q10 =      # transition rate, dormancy -> no
p   =            # escape rate

Now that BiSSE is working, I want to run MuSSE with multiple states (dormancy-0,1, and competition-A,B)

Need to first make a trait that has 0-3 representing 0A, 1A, 0B, 1B.
```{r}
primates$trait <- primates$trait %>% mutate(T3 = case_when(T1 == 0 & T2 == 0 ~ "1",
                                                           T1 == 1 & T2 == 0 ~ "2",
                                                           T1 == 0 & T2 == 1 ~ "3",
                                                           T1 == 1 & T2 == 1 ~ "4")) %>%
   mutate_at(.vars = vars(T3), .funs = as.numeric) 

trait3 <- primates$trait[,4]
names(trait3) <- primates$trait[,1]
# 1   2   3   4
# 0A, 1A, 0B, 1B
```

```{r}
make.musse.multitrait(tree = primates$tree,
                      states = trait3,
                      sampling.f = c(1,1),
                      allow.multistep = TRUE,
                      control=list())
musse_fn <- make.musse(tree = primates$tree,
            states = trait3,
            k = 4,
            sampling.f = c(1,1,1,1)
            )
```

```{r}
startingparammusse <- starting.point.musse(tree = primates$tree, k = 4)
```

```{r}
musse_fit <- find.mle(musse_fn, startingparammusse)
musse_fit
```


```{r}
musse_fit$par
```




```{r}
generator <- function(p) {
   lambda1 <- runif(1, min = 0, max = 1)
   lambda2 <- runif(1, min = 0, max = lambda1)
   lambda3 <- runif(1, min = 0, max = 1)
   lambda4 <- runif(1, min = 0, max = lambda3)
   mu1 <- runif(1, min = 0, max = 1)
   mu2 <- runif(1, min = 0, max = 1/p)
   mu3 <- runif(1, min = 0, max = 1)
   mu4 <- runif(1, min = 0, max = 1/p)
   q12 <- runif(1, min = 0, max = 1)
   q13 <- runif(1, min = 0, max = 1)
   q14 <- 0
   q21 <- runif(1, min = 0, max = 1)
   q23 <- runif(1, min = 0, max = 1)
   q24 <- runif(1, min = 0, max = 1)
   q31 <- runif(1, min = 0, max = 1)
   q32 <- runif(1, min = 0, max = 1)
   q34 <- runif(1, min = 0, max = 1)
   q41 <- 0
   q42 <- runif(1, min = 0, max = 1)
   q43 <- runif(1, min = 0, max = 1)
   
   arguments <- c(lambda1,lambda2,lambda3,lambda4,mu1,mu2,mu3,mu4,q12,q13,q14,q21,q23,q24,q31,q32,q34,q41,q42,q43)
   results <- musse_fn(arguments)
   output <- list(arguments, results)
   output
}
```


```{r}
test1 <- generator(5)
```







